import {
	generatePlanForUser,
	getActivePlanForUser,
	deactivatePlan,
	adjustPlan,
} from "../services/planGenerator.service.js";
import {
	suggestAdjustments,
	autoAdjustPlan,
} from "../services/planProgression.service.js";
import AutoGeneratedPlan from "../models/autoGeneratedPlan.model.js";

const generateAutoPlan = async (req, res) => {
	try {
		const userId = req.user.id;
		const plan = await generatePlanForUser(userId);
		return res.status(201).json({
			message: "Auto-generated plan created successfully",
			plan,
		});
	} catch (err) {
		console.error(err);
		return res.status(500).json({ message: err.message });
	}
};

const getCurrentAutoPlan = async (req, res) => {
	try {
		const userId = req.user.id;
		const plan = await getActivePlanForUser(userId);
		if (!plan) {
			return res.status(404).json({ message: "No active auto plan found" });
		}
		return res.json({ plan });
	} catch (err) {
		console.error(err);
		return res.status(500).json({ message: err.message });
	}
};

const adjustAutoPlan = async (req, res) => {
	try {
		const userId = req.user.id;
		const { id } = req.params;
		const adjustments = req.body;

		const plan = await adjustPlan(id, userId, adjustments);
		return res.json({
			message: "Plan adjusted successfully",
			plan,
		});
	} catch (err) {
		console.error(err);
		return res.status(500).json({ message: err.message });
	}
};

const triggerProgression = async (req, res) => {
	try {
		const userId = req.user.id;
		const { id } = req.params;

		// Get suggestions first
		const suggestions = await suggestAdjustments(userId, id);

		// Check if user wants to auto-apply or just see suggestions
		const { autoApply } = req.body;

		if (autoApply) {
			const result = await autoAdjustPlan(id, userId);
			return res.json({
				message: "Progression applied successfully",
				plan: result.plan,
				appliedAdjustments: result.appliedAdjustments,
			});
		}

		return res.json({
			message: "Progression suggestions generated",
			suggestions,
		});
	} catch (err) {
		console.error(err);
		return res.status(500).json({ message: err.message });
	}
};

const deactivateAutoPlan = async (req, res) => {
	try {
		const userId = req.user.id;
		const { id } = req.params;

		const plan = await deactivatePlan(id, userId);
		return res.json({
			message: "Plan deactivated successfully",
			plan,
		});
	} catch (err) {
		console.error(err);
		return res.status(500).json({ message: err.message });
	}
};

const getAutoPlanById = async (req, res) => {
	try {
		const userId = req.user.id;
		const { id } = req.params;

		const plan = await AutoGeneratedPlan.findOne({ _id: id, userId }).populate(
			"weeklyStructure.exercises.exerciseId"
		);

		if (!plan) {
			return res.status(404).json({ message: "Plan not found" });
		}

		return res.json({ plan });
	} catch (err) {
		console.error(err);
		return res.status(500).json({ message: err.message });
	}
};

export {
	generateAutoPlan,
	getCurrentAutoPlan,
	adjustAutoPlan,
	triggerProgression,
	deactivateAutoPlan,
	getAutoPlanById,
};
