# Auto-Generated Plan Integration Summary

This document summarizes all changes made to integrate form-based auto-plan generation with progression tracking and upcoming sessions display.

## Overview

The system now supports:
1. ✅ Form-based auto-plan generation (uses form data instead of just profile)
2. ✅ Progression tracking based on user performance
3. ✅ Upcoming sessions calendar view (next 2 weeks)
4. ✅ Progression suggestions with apply/dismiss options
5. ✅ Progression history display

---

## Backend Changes

### 1. User Model (`backend/models/user.model.js`)
**Added:**
- `preferred_days` field to ProfileSchema
  ```javascript
  preferred_days: { 
    type: [String], 
    enum: ["monday", "tuesday", "wednesday", "thursday", "friday", "saturday", "sunday"],
    default: [] 
  }
  ```

### 2. Auto-Generated Plan Controller (`backend/controllers/autoGeneratedPlan.controllers.js`)
**Modified `generateAutoPlan` function:**
- Now extracts form data from `req.body`
- Passes `formData` to `generatePlanForUser(userId, formData)`

```javascript
const generateAutoPlan = async (req, res) => {
  try {
    const userId = req.user.id;
    const formData = req.body; // Extract form data from request body
    const plan = await generatePlanForUser(userId, formData);
    
    return res.json({
      message: "Plan generated successfully",
      plan,
    });
  } catch (err) {
    console.error(err);
    return res.status(500).json({ message: err.message });
  }
};
```

### 3. Plan Generator Service (`backend/services/planGenerator.service.js`)
**Major refactor of `generatePlanForUser` function:**

**Before:**
```javascript
async function generatePlanForUser(userId) {
  const user = await User.findById(userId);
  const { goals, experience_level, equipment, days_per_week, session_length_minutes, injuries, preferences } = user.profile;
  // ... rest of the logic
}
```

**After:**
```javascript
async function generatePlanForUser(userId, formData = null) {
  const user = await User.findById(userId);
  
  // Use formData if provided, otherwise fall back to profile
  const params = formData ? {
    goals: Array.isArray(formData.goal) ? formData.goal : [formData.goal],
    experience_level: formData.experience_level || user.profile.experience_level,
    equipment: formData.equipment || user.profile.equipment,
    days_per_week: formData.days_per_week || user.profile.days_per_week,
    preferred_days: formData.preferred_days || user.profile.preferred_days || [],
    session_length_minutes: formData.session_length_minutes || user.profile.session_length_minutes,
    injuries: formData.injuries ? 
      (typeof formData.injuries === 'string' ? formData.injuries.split(',').map(i => i.trim()) : formData.injuries) 
      : user.profile.injuries,
    preferences: formData.focus_areas || user.profile.preferences
  } : {
    goals: user.profile.goals,
    experience_level: user.profile.experience_level,
    equipment: user.profile.equipment,
    days_per_week: user.profile.days_per_week,
    preferred_days: user.profile.preferred_days || [],
    session_length_minutes: user.profile.session_length_minutes,
    injuries: user.profile.injuries,
    preferences: user.profile.preferences
  };
  
  // Update user profile with form data if provided
  if (formData) {
    await User.findByIdAndUpdate(userId, {
      $set: {
        'profile.goals': params.goals,
        'profile.experience_level': params.experience_level,
        'profile.equipment': params.equipment,
        'profile.days_per_week': params.days_per_week,
        'profile.preferred_days': params.preferred_days,
        'profile.session_length_minutes': params.session_length_minutes,
        'profile.injuries': params.injuries,
        'profile.preferences': params.preferences
      }
    });
  }
  
  // Deactivate existing active plans before creating new one
  await AutoGeneratedPlan.updateMany(
    { userId, active: true },
    { $set: { active: false } }
  );
  
  // ... rest of generation logic with params
  
  // Include dayOfWeek in weeklyStructure
  weeklyStructure.push({
    dayNumber: i + 1,
    dayOfWeek: dayTemplate.dayOfWeek,
    name: dayTemplate.name,
    focus: dayTemplate.focus,
    exercises: exercisesForDay
  });
}
```

**Key Changes:**
1. Accepts optional `formData` parameter
2. Conditionally uses formData or profile data
3. Maps form fields to expected parameter names:
   - `goal` → `goals` (converts to array)
   - `injuries` string → array
   - `focus_areas` → `preferences`
4. Updates user profile when form data is provided
5. Deactivates old active plans before creating new one
6. Includes `dayOfWeek` in weeklyStructure output

### 4. Progression Service (`backend/services/planProgression.service.js`)
**Already implemented:**
- ✅ `analyzePerformance(userId, lastNWeeks)` - Analyzes session logs
- ✅ `suggestAdjustments(userId, autoGeneratedPlanId)` - Generates progression suggestions
- ✅ `autoAdjustPlan(planId, userId)` - Applies adjustments automatically
- ✅ `handlePlateau(exerciseId, performanceData)` - Handles plateaus
- ✅ `deloadIfNeeded(plan, fatigueIndicators)` - Applies deload when needed

**Progression Logic:**
- Tracks RPE (Rate of Perceived Exertion)
- Monitors completion rates
- Detects progression readiness (2+ successful sessions with RPE < 8)
- Detects plateaus (difficult sessions or RPE ≥ 9)
- Applies progression rules: `reps_then_load`, `load`, `reps`

---

## Frontend Changes

### 1. MyPlans.jsx (`frontend/src/pages/MyPlans.jsx`)
**Complete overhaul with new features:**

#### New Imports:
```javascript
import { TrendingUp, AlertCircle } from "lucide-react";
import { useAutoPlanStore } from "../store/autoPlan/autoPlanStore";
```

#### New State Variables:
```javascript
const [upcomingSessions, setUpcomingSessions] = useState([]);
const [showProgression, setShowProgression] = useState(false);
const [progressionSuggestions, setProgressionSuggestions] = useState([]);
const [loadingProgression, setLoadingProgression] = useState(false);
const { triggerProgression } = useAutoPlanStore();
```

#### New Functions:

**1. Generate Upcoming Sessions:**
```javascript
const generateUpcomingSessions = () => {
  // Maps preferred days to actual calendar dates
  // Shows next 14 days of workouts
  // Matches workout days to dayOfWeek in plan structure
}
```

**2. Check Progression:**
```javascript
const handleCheckProgression = async () => {
  const result = await triggerProgression(planId, false);
  setProgressionSuggestions(result.data.suggestions);
}
```

**3. Apply Progression:**
```javascript
const handleApplyProgression = async () => {
  await triggerProgression(planId, true);
  await fetchUserPlan(); // Refresh plan
  setProgressionSuggestions([]);
}
```

#### New UI Components:

**1. Upcoming Sessions View:**
- Shows next 2 weeks of scheduled workouts
- Highlights today's workout
- Shows exercise preview (first 3 exercises)
- Displays sets/reps/load for each exercise
- Color-coded badges for dates

**2. Progression Suggestions Panel:**
- Displays suggested adjustments
- Shows current vs suggested values side-by-side
- Color-coded by type (progression = success, deload = warning)
- "Apply All" or "Dismiss" buttons
- Reason for each suggestion

**3. Progression History Section:**
- Shows last 5 progression adjustments
- Date and adjustment count
- Detailed change descriptions and reasons
- "View All" button if more than 5 entries

**4. Check Progression Button:**
- Added to plan overview card
- Only visible for auto-generated plans
- Triggers progression analysis
- Shows loading spinner during check

#### Layout Order:
1. Progression Suggestions (if available)
2. Upcoming Sessions
3. Plan Overview
4. Workout Details (expandable days)
5. Progression History

---

## How It Works

### Form Submission Flow:

1. **User fills out AutoPlanGenerator form:**
   - Goal (muscle_gain, strength, endurance, etc.)
   - Experience level (beginner, intermediate, advanced)
   - Equipment available
   - Days per week
   - Preferred days (Monday, Wednesday, Friday, etc.)
   - Session length (minutes)
   - Injuries
   - Focus areas

2. **Form submits to `/api/auto-plan/generate`:**
   ```javascript
   const result = await generateAutoPlan(formData);
   ```

3. **Backend receives form data:**
   - Controller extracts `req.body`
   - Passes to `generatePlanForUser(userId, formData)`

4. **Service processes form data:**
   - Maps form fields to expected parameters
   - Updates user profile with form data
   - Deactivates old active plans
   - Generates new plan structure
   - Assigns exercises to preferred days
   - Calculates sets/reps/load based on experience level
   - Saves plan with `dayOfWeek` assignments

5. **Plan is created and activated:**
   - UserPlan document created/updated
   - Points to AutoGeneratedPlan
   - User redirected to My Plans page

### Upcoming Sessions Display:

1. **MyPlans loads user's active plan:**
   - Fetches from `/api/user-plan`
   - Populates full exercise details

2. **Generates upcoming sessions:**
   - Gets preferred days from plan
   - Iterates next 14 days
   - Matches calendar days to workout days
   - Creates session preview with exercises

3. **Renders calendar view:**
   - Shows date, workout name, focus
   - Displays exercise preview
   - Highlights today's workout

### Progression Flow:

1. **User clicks "Check Progression":**
   - Calls `/api/auto-plan/{id}/progress` with `autoApply: false`
   - Backend analyzes last 2 weeks of SessionLog entries
   - Calculates RPE averages, completion rates
   - Generates suggestions for each exercise

2. **Suggestions displayed:**
   - Shows current vs suggested values
   - Explains reason (e.g., "Completed successfully for 2+ sessions with RPE < 8")
   - Color-coded by type

3. **User applies suggestions:**
   - Calls same endpoint with `autoApply: true`
   - Backend updates plan exercises with new values
   - Adds entry to progressionHistory
   - Frontend refreshes plan data

4. **Progression history updated:**
   - Shows in separate section
   - Displays date and adjustments made
   - Provides historical context

---

## API Endpoints Used

### Auto-Plan Generation:
- `POST /api/auto-plan/generate` - Generate new plan with form data
- `GET /api/auto-plan/current` - Get current active auto-plan
- `GET /api/auto-plan/{id}` - Get specific auto-plan by ID

### Progression:
- `POST /api/auto-plan/{id}/progress` - Trigger progression analysis
  - Body: `{ autoApply: true/false }`
  - Returns suggestions if false, applies if true

### Plan Management:
- `GET /api/user-plan` - Get user's active plan (template or auto-generated)
- `DELETE /api/auto-plan/{id}` - Deactivate auto-plan

### Session Tracking:
- `GET /api/daily-session/today` - Get today's workout session
- `GET /api/daily-session/:date` - Get session for specific date
- `POST /api/session-log` - Log completed workout (used by progression)

---

## Testing Checklist

### Form-Based Generation:
- [ ] Fill out AutoPlanGenerator form with all fields
- [ ] Verify form validation (preferred_days count = days_per_week)
- [ ] Submit form and check plan is created
- [ ] Verify user profile is updated with form data
- [ ] Check old active plans are deactivated
- [ ] Verify exercises are assigned to correct days

### Upcoming Sessions:
- [ ] Open My Plans page
- [ ] Verify upcoming sessions show next 2 weeks
- [ ] Check today's workout is highlighted
- [ ] Verify exercise previews display correctly
- [ ] Check date formatting is correct
- [ ] Verify days match preferred days from form

### Progression:
- [ ] Complete 2-3 workouts with low RPE (< 8)
- [ ] Click "Check Progression" button
- [ ] Verify suggestions appear
- [ ] Check current vs suggested values are correct
- [ ] Click "Apply All" and verify plan updates
- [ ] Check progression history shows new entry
- [ ] Verify exercises have updated sets/reps/load

### Edge Cases:
- [ ] No active plan - shows proper message
- [ ] New user with no workout history - no progression suggestions
- [ ] High RPE workouts - suggests deload
- [ ] Failed sessions - suggests deload or modifications
- [ ] Template-based plan - no progression button shown
- [ ] Auto-generated plan with no preferred days - falls back gracefully

---

## Database Schema Updates

### User.ProfileSchema:
```javascript
{
  preferred_days: [String] // NEW: ["monday", "wednesday", "friday"]
}
```

### AutoGeneratedPlan.WeeklyStructureSchema:
```javascript
{
  dayOfWeek: String // NEW: "monday", "tuesday", etc.
}
```

---

## Configuration Required

### Frontend (.env):
```env
VITE_API_URL=http://localhost:5000/api
VITE_ENV=development
```

### Backend (.env):
```env
MONGO_URI=mongodb://localhost:27017/flexora
PORT=5000
JWT_SECRET=your_secret_key
```

---

## Next Steps & Recommendations

### Immediate:
1. **Restart backend server** to apply model changes
2. **Test complete flow** from form submission to progression
3. **Verify data persistence** in MongoDB

### Short-term Improvements:
1. Add pagination to progression history
2. Show RPE trends in charts
3. Add notification when progression is ready
4. Allow manual adjustment of individual exercises
5. Add "Skip" option for specific suggestions

### Long-term Features:
1. AI-powered exercise substitutions based on equipment/injuries
2. Predictive progression timing based on user patterns
3. Integration with wearable devices for RPE estimation
4. Social features: share plans, compare progression
5. Detailed analytics dashboard with graphs

---

## Troubleshooting

### Issue: Upcoming sessions not showing
**Solution:** Check that:
- Plan has `preferred_days` array populated
- Workout days have `dayOfWeek` field
- Frontend is correctly mapping day names to numbers

### Issue: Progression suggestions always empty
**Solution:** Verify:
- User has completed at least 2 workouts
- SessionLog entries exist with status="done" and RPE values
- Exercises have `progression_rule` defined
- Auto-plan ID is correct

### Issue: Form data not updating plan
**Solution:** Check:
- Backend server restarted after model changes
- Form field names match expected parameters
- Console logs show formData in controller
- User profile fields are being updated

### Issue: Old plans not deactivating
**Solution:** Verify:
- `AutoGeneratedPlan.updateMany` query is running
- MongoDB indexes are correct
- `active: true` field exists on old plans

---

## Success Criteria

✅ User can generate plan from form without setting profile first
✅ Generated plan uses form-submitted data (goal, days, equipment, etc.)
✅ User profile is automatically updated with form data
✅ Old active plans are deactivated when new plan is created
✅ Upcoming sessions display shows next 2 weeks with correct days
✅ Progression button checks performance and shows suggestions
✅ Suggestions display current vs suggested values with reasons
✅ Apply progression updates plan and shows in history
✅ All features work for both new and existing users
✅ System handles edge cases gracefully (no data, errors, etc.)

---

## Files Modified

### Backend:
1. `backend/models/user.model.js` - Added `preferred_days` to ProfileSchema
2. `backend/controllers/autoGeneratedPlan.controllers.js` - Extract formData from req.body
3. `backend/services/planGenerator.service.js` - Accept formData, map fields, update profile
4. `backend/services/planProgression.service.js` - Already complete

### Frontend:
1. `frontend/src/pages/MyPlans.jsx` - Complete overhaul with:
   - Upcoming sessions view
   - Progression suggestions panel
   - Progression history display
   - Check/apply progression buttons
2. `frontend/src/store/autoPlan/autoPlanStore.js` - Already had triggerProgression

### Documentation:
1. `AUTO_PLAN_INTEGRATION_SUMMARY.md` - This file

---

## Conclusion

The auto-generated plan system now provides a complete end-to-end experience:
1. ✅ Form-based plan generation with all user preferences
2. ✅ Smart progression tracking based on performance
3. ✅ Visual upcoming sessions calendar
4. ✅ Progression suggestions with apply/dismiss workflow
5. ✅ Historical tracking of all adjustments

Users can now create personalized workout plans, see their upcoming workouts, track progression, and have the system automatically adjust their training based on performance data.
